<!DOCTYPE html>
<html>
<head>
    <title>Tamil Nadu Trekking Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="filters">
        <h3 style="margin-top: 0; margin-bottom: 20px;">Trek Filters</h3>
        <div class="filter-group">
            <h4>Distance (km)</h4>
            <div id="distance-slider"></div>
            <div class="slider-values">
                <span id="distance-min">0 km</span>
                <span id="distance-max">20 km</span>
            </div>
        </div>
        <div class="filter-group">
            <h4>Price (₹)</h4>
            <div id="price-slider"></div>
            <div class="slider-values">
                <span id="price-min">₹0</span>
                <span id="price-max">₹4000</span>
            </div>
        </div>
        <div class="filter-group">
            <h4>Duration (Hours)</h4>
            <div id="duration-slider"></div>
            <div class="slider-values">
                <span id="duration-min">0h</span>
                <span id="duration-max">8h</span>
            </div>
        </div>
        <div class="filter-group">
            <h4>Type</h4>
            <div class="type-filter">
                <label>
                    <input type="checkbox" value="one way" checked> One Way
                </label>
                <label>
                    <input type="checkbox" value="two way" checked> Two Way
                </label>
            </div>
        </div>
        <button class="apply-filters" onclick="applyFilters()">Apply Filters</button>
        <button class="reset-filters" onclick="resetFilters()">Reset Filters</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nouislider@14.6.3/distribute/nouislider.min.js"></script>
    <script>
        // Initialize map with a custom theme
        const map = L.map('map').setView([11.1271, 78.6569], 7);

        // Add a beautiful terrain-style map theme using Thunderforest Outdoors
        L.tileLayer('https://{s}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png?apikey=6170aad10dfd42a38d4d8c709a536f38', {
            attribution: '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 22
        }).addTo(map);

        // Create marker groups for each difficulty
        const markerGroups = {
            'Easy': L.markerClusterGroup(),
            'Moderate': L.markerClusterGroup(),
            'Tough': L.markerClusterGroup()
        };

        // Define marker colors for difficulties
        const difficultyColors = {
            'Easy': '#2ecc71',
            'Moderate': '#f1c40f',
            'Tough': '#e74c3c'
        };

        // Store all treks and markers for filtering
        let allTreks = [];
        let activeMarkers = new Set();

        // Initialize range sliders
        const sliders = {
            distance: {
                element: document.getElementById('distance-slider'),
                min: 0,
                max: 20,
                start: [0, 20],
                step: 1,
                format: value => `${value} km`
            },
            price: {
                element: document.getElementById('price-slider'),
                min: 0,
                max: 4000,
                start: [0, 4000],
                step: 100,
                format: value => `₹${value}`
            },
            duration: {
                element: document.getElementById('duration-slider'),
                min: 0,
                max: 8,
                start: [0, 8],
                step: 0.5,
                format: value => `${value}h`
            }
        };

        // Initialize all sliders
        Object.entries(sliders).forEach(([key, slider]) => {
            noUiSlider.create(slider.element, {
                start: slider.start,
                connect: true,
                step: slider.step,
                range: {
                    'min': slider.min,
                    'max': slider.max
                }
            });

            // Update value displays
            const minElement = document.getElementById(`${key}-min`);
            const maxElement = document.getElementById(`${key}-max`);
            
            slider.element.noUiSlider.on('update', (values, handle) => {
                const value = parseFloat(values[handle]);
                if (handle === 0) {
                    minElement.textContent = slider.format(value);
                } else {
                    maxElement.textContent = slider.format(value);
                }
            });
        });

        // Create custom marker icons
        function createMarkerIcon(color) {
            return L.divIcon({
                html: `<div style="
                    background-color: ${color};
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    border: 2px solid white;
                    box-shadow: 0 0 4px rgba(0,0,0,0.4);
                "></div>`,
                className: 'custom-marker',
                iconSize: [16, 16]
            });
        }

        // Parse trek details
        function parseTrekDetails(details) {
            const parsed = {};
            details.split(',').forEach(detail => {
                const [key, value] = detail.trim().split(':').map(s => s.trim());
                if (key === 'Distance') {
                    parsed.distance = parseFloat(value.replace('km', ''));
                } else if (key === 'Duration') {
                    parsed.duration = parseFloat(value.replace('Hours', ''));
                } else if (key === 'Price') {
                    parsed.price = parseFloat(value.replace('₹', ''));
                } else if (key === 'Type') {
                    parsed.type = value.toLowerCase();
                }
            });
            return parsed;
        }

        // Filter treks based on criteria
        function filterTreks() {
            const [minDistance, maxDistance] = sliders.distance.element.noUiSlider.get().map(Number);
            const [minPrice, maxPrice] = sliders.price.element.noUiSlider.get().map(Number);
            const [minDuration, maxDuration] = sliders.duration.element.noUiSlider.get().map(Number);
            const selectedTypes = Array.from(document.querySelectorAll('.type-filter input:checked')).map(cb => cb.value);

            return allTreks.filter(trek => {
                const details = parseTrekDetails(trek.details);
                return (
                    details.distance >= minDistance &&
                    details.distance <= maxDistance &&
                    details.price >= minPrice &&
                    details.price <= maxPrice &&
                    details.duration >= minDuration &&
                    details.duration <= maxDuration &&
                    selectedTypes.includes(details.type)
                );
            });
        }

        // Apply filters
        function applyFilters() {
            // Clear all markers
            Object.values(markerGroups).forEach(group => {
                group.clearLayers();
            });

            // Apply filters and add matching markers
            const filteredTreks = filterTreks();
            filteredTreks.forEach(trek => {
                const icon = createMarkerIcon(difficultyColors[trek.difficulty]);
                const marker = L.marker([trek.lat, trek.lng], { icon });
                
                const popupContent = `
                    <h3>${trek.name}</h3> 
                    <strong>Difficulty:</strong> <span style="color: ${difficultyColors[trek.difficulty]}">${trek.difficulty}</span><br>
                    ${trek.details.split(',').join('<br>')}<br>
                    <div style="margin-top: 10px;">
                        <a href="${trek.url}" target="_blank" class="btn" style="
                            display: inline-block;
                            padding: 8px 16px;
                            background-color: ${difficultyColors[trek.difficulty]};
                            color: white;
                            text-decoration: none;
                            border-radius: 4px;
                            transition: opacity 0.2s;
                        ">Trail Details</a> 
                    </div>
                `;
                marker.bindPopup(popupContent);
                markerGroups[trek.difficulty].addLayer(marker);
            });

            // Update the map with filtered markers
            Object.values(markerGroups).forEach(group => {
                if (!group.inactive) {
                    map.addLayer(group);
                }
            });
        }

        // Reset filters
        function resetFilters() {
            // Reset all sliders to their initial values
            Object.entries(sliders).forEach(([key, slider]) => {
                slider.element.noUiSlider.set(slider.start);
            });

            // Reset checkboxes
            document.querySelectorAll('.type-filter input').forEach(cb => cb.checked = true);
            
            // Apply the reset filters
            applyFilters();
        }

        // Fetch trek data from JSON file
        fetch('tracks.json')
            .then(response => response.json())
            .then(treks => {
                allTreks = treks;
                treks.forEach(trek => {
                    const icon = createMarkerIcon(difficultyColors[trek.difficulty]);
                    const marker = L.marker([trek.lat, trek.lng], { icon });
                    
                    const popupContent = `
                        <h3>${trek.name}</h3> 
                        <strong>Difficulty:</strong> <span style="color: ${difficultyColors[trek.difficulty]}">${trek.difficulty}</span><br>
                        ${trek.details.split(',').join('<br>')}<br>
                        <div style="margin-top: 10px;">
                            <a href="${trek.url}" target="_blank" class="btn" style="
                                display: inline-block;
                                padding: 8px 16px;
                                background-color: ${difficultyColors[trek.difficulty]};
                                color: white;
                                text-decoration: none;
                                border-radius: 4px;
                                transition: opacity 0.2s;
                            ">Trail Details</a> 
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    markerGroups[trek.difficulty].addLayer(marker);
                });

                // Add all marker groups to the map initially
                Object.values(markerGroups).forEach(group => map.addLayer(group));
            })
            .catch(error => console.error('Error loading trek data:', error));

        // Add interactive legend
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = () => {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <h4>Trek Difficulty</h4>
                ${Object.entries(difficultyColors).map(([difficulty, color]) => `
                    <div class="legend-item" data-difficulty="${difficulty}">
                        <span class="legend-marker" style="background-color: ${color}"></span>
                        ${difficulty}
                    </div>
                `).join('')}
            `;

            // Add click handlers for legend items
            setTimeout(() => {
                const items = div.getElementsByClassName('legend-item');
                Array.from(items).forEach(item => {
                    item.addEventListener('click', () => {
                        const difficulty = item.dataset.difficulty;
                        item.classList.toggle('inactive');
                        markerGroups[difficulty].inactive = item.classList.contains('inactive');
                        
                        if (markerGroups[difficulty].inactive) {
                            map.removeLayer(markerGroups[difficulty]);
                        } else {
                            map.addLayer(markerGroups[difficulty]);
                        }
                    });
                });
            }, 0);

            return div;
        };
        legend.addTo(map);
    </script>
</body>
</html>